// This file is part of mmdl, a C++ template library
// for dislocation networks in crystals.
//
// Copyright (C) 2009 Giacomo Po <giacomopo@gmail.com>, 
// Benjamin Ramirez <ramirezbrf@gmail.com>
//
// mmdl is distributed without any warranty under the 
// GNU Lesser General Public License <http://www.gnu.org/licenses/>.


#ifndef mmdl_SLIPSYSTEM_H_
#define mmdl_SLIPSYSTEM_H_

#include <assert.h>
#include <Eigen/Dense>
#include <mmdl/Utilities/StaticID.h>

namespace mmdl {
	
	//////////////////////////////////////////////////////////
	// SlipSystem
	template<short unsigned int dim, short unsigned int Nslips>
	class SlipSystem : public mmdl::StaticID<SlipSystem<dim,Nslips> >{
		
		typedef Eigen::Matrix<double,dim,1>			VectorDim;
		typedef Eigen::Matrix<double,dim,Nslips>	MatrixDimNslips;
		
		//////////////////////////////////////////////////////////////////////////
		static MatrixDimNslips normalizeByColumns(const MatrixDimNslips& slip_in){
			MatrixDimNslips temp;
			for(int k=0; k<Nslips;++k){
				assert(slip_in.col(k).squaredNorm()>0.0);
				temp.col(k)=slip_in.col(k).normalized();
			}
			return temp;
		}

		
	public:
		
		const VectorDim normal;
		const MatrixDimNslips slip;
//		const MatrixDimNslips slip;

		
		//////////////////////////////////
		//Constructor
		SlipSystem(const VectorDim & normal_in, const MatrixDimNslips & slip_in) : normal(normal_in.normalized()), slip(normalizeByColumns(slip_in)){
			
			double tol=1.0e-14;
			
			for(int k=0; k<Nslips;++k){
//				std::cout<<"Creating slip system ("<<normal.transpose()<<")["<<slip.col(k).transpose()<<"]"<<std::endl;
				assert(std::fabs(normal.dot(slip.col(k)))<tol);
			}
			
			
		}
		
//		//////////////////////////////////
//		//Destructor
//		~SlipSystem(){
//			
//			
//			for(int k=0; k<Nslips;++k){
//				std::cout<<"Deleting slip system ("<<normal.transpose()<<")["<<slip.col(k).transpose()<<"]"<<std::endl;
//			}
//			
//			
//		}
		
		bool operator<(const SlipSystem & Other) const {
			return this->sID<Other.sID;
		}
		
		
	};
	//////////////////////////////////////////////////////////////
} // namespace mmdl 
#endif
